pipeline {
    agent any // Runs on your Mac

    tools {
        jdk 'JDK 17'
        maven 'Maven 3.8'
    }

    stages {
        stage('Build Jar') {
            steps {
                echo 'Building the Spring Boot application...'
                sh 'mvn -f showtime-backend/pom.xml clean package -DskipTests'
            }
        }

        stage('Archive Artifacts') {
            steps {
                echo 'Archiving the .jar file...'
                archiveArtifacts artifacts: 'showtime-backend/target/*.jar', fingerprint: true
            }
        }

        // --- NEW STAGE 1: BUILD THE IMAGE ---
        stage('Build Docker Image') {
            steps {
                echo 'Building Docker image...'
                // -f points to your Dockerfile's location
                // -t gives the image a name (tag)
                // . is the build context (your entire project directory)
                sh 'docker build -f showtime-backend/Dockerfile -t showtime-app:latest .'
            }
        }

        // --- NEW STAGE 2: RUN THE CONTAINER ---
        stage('Run Docker Container') {
            steps {
                echo 'Stopping and removing old container...'
                // '|| true' ensures the build doesn't fail if the container doesn't exist
                sh 'docker stop showtime-container && docker rm showtime-container || true'

                echo 'Starting new container...'
                // This is the key command:
                // -d: Run in detached (background) mode
                // --name: Give your container a name to find it easily
                // -p 8080:8080: Map port 8080 on your Mac to port 8080 in the container
                // -e: Set environment variables for Spring Boot
                // host.docker.internal: The magic DNS for connecting to your Mac's localhost
                sh '''
                    docker run -d --name showtime-container -p 8080:8080 \
                    -e SPRING_DATASOURCE_URL=jdbc:postgresql://host.docker.internal:5432/showtime \
                    -e SPRING_DATASOURCE_USERNAME=postgres \
                    -e SPRING_DATASOURCE_PASSWORD=postgres \
                    -e SPRING_DATA_REDIS_HOST=host.docker.internal \
                    -e SPRING_JPA_HIBERNATE_DDL_AUTO=update \
                    -e SPRING_JPA_PROPERTIES_HIBERNATE_DEFAULT_SCHEMA=showtime \
                    showtime-app:latest
                '''
            }
        }
    }
}